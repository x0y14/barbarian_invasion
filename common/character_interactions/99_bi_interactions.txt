bi_request_nomadic_invasion_interaction = {
	interface_priority = 100
	common_interaction = yes
	category = interaction_category_hostile
	cooldown_against_recipient = { years = 10 }

	icon = request_mercenary
	desc = fp3_request_turkic_invasion_interaction_desc

	is_shown = {
		# always = no
		# ルールで禁止されていないこと
		NOT = { has_game_rule = nomadic_invasion_off }

		# たまにの設定ならはじめの30年はできないように
		trigger_if = {
			limit = {
				has_game_rule = nomadic_invasion_occasional
			}
			current_date >= 897.1.1
		}
		# 頻繁にの設定ならはじめの15年はできないように
		trigger_if = {
			limit = {
				has_game_rule = nomadic_invasion_frequent
			}
			current_date >= 882.1.1
		}

		scope:actor = {
			# 土地持ち
			is_landed = yes

			# aiであること
			is_ai = yes
			
			# テュルク系部族
			has_government = tribal_government
			OR = {
				culture = { has_cultural_pillar = heritage_turkic }
				culture = { has_cultural_pillar = heritage_mongolic }
			}
			
			# テングリかイスラム系宗教
			OR = {
				AND = {
					current_date >= 1066.1.1
					faith.religion = religion:islam_religion
				}
				faith = faith:tengri_pagan
			}

			NOT = { highest_held_title_tier >= tier_kingdom }
		}

		scope:recipient = {
			is_landed = yes
			highest_held_title_tier >= tier_county
			is_independent_ruler = yes
			
			NOT = { faith = scope:actor.faith }
			NOT = { faith = scope:secondary_recipient.faith }
			NOT = { has_government = tribal_government }
			NOT = { has_character_flag = recently_nomadic_invaded }
		}

		NOT = { scope:actor = scope:recipient }
	}

	is_valid_showing_failures_only = {}

	populate_recipient_list = {
		scope:actor.top_liege = {
			every_independent_ruler = {
				limit = {
					# 土地持ち
					is_landed = yes

					# aiであること
					is_ai = yes

					# 最近攻撃していない人
					NOT = { has_character_flag = recently_declare_nomadic_invasion }

					# テュルク系部族
					has_government = tribal_government
					OR = {
						culture = { has_cultural_pillar = heritage_turkic }
						culture = { has_cultural_pillar = heritage_mongolic }
					}
					
					# テングリかイスラム系宗教
					OR = {
						AND = {
							current_date >= 1066.1.1
							faith.religion = religion:islam_religion
						}
						faith = faith:tengri_pagan
					}

					# 王国以上であること
					highest_held_title_tier >= tier_kingdom

					# 独立していること
					is_independent_ruler = yes

					has_raised_armies = no

					NOR = {
						is_at_war_with = scope:actor
						is_at_war_with = scope:recipient
						is_allied_to = scope:recipient
						has_truce = scope:recipient
						this = scope:actor
						this = scope:recipient
					}
					# in_diplomatic_range = scope:recipient
				}
				add_to_list = characters
			}
		}
	}

	cost = {
		gold = {
			add = {
				value = 100
			}
		}
	}

	on_accept = {
		if = {
			limit = { exists = scope:secondary_recipient }
		}
		scope:recipient = {
			if = {
				limit = {
					any_realm_county = {
						NOT = { this = scope:recipient.capital_county }
						NOR = {
							holder = scope:actor
							holder = { is_vassal_or_below_of = scope:actor }
						}
					}
				}
				random_realm_county = {
					limit = {
						NOT = { this = scope:recipient.capital_county }
						NOR = {
							holder = scope:actor
							holder = { is_vassal_or_below_of = scope:actor }
						}
					}
					save_scope_as = invasion_target_title
				}
			}
			else_if = {
				limit = {
					any_realm_county = {
						NOR = {
							holder = scope:actor
							holder = { is_vassal_or_below_of = scope:actor }
						}
					}
				}
				random_realm_county = {
					limit = {
						NOR = {
							holder = scope:actor
							holder = { is_vassal_or_below_of = scope:actor }
						}
					}
					save_scope_as = invasion_target_title
				}
			}
			else = {
				random_realm_county = { save_scope_as = invasion_target_title }
			}

			scope:invasion_target_title.duchy = { save_scope_as = text_title }

			hidden_effect = { # Not worth cluttering the UI with
				add_opinion = {
					modifier = declared_war
					target = scope:secondary_recipient
				}
			}
		}

		scope:secondary_recipient = {
			start_war = {
				casus_belli = sponsored_nomadic_invasion
				target = scope:recipient
				target_title = scope:invasion_target_title.duchy
			}
			custom_tooltip = sponsored_nomadic_invasion_cb_result_tt
		}
	}

	use_diplomatic_range = yes

	ai_accept = {
		base = -30

		# Relationships: actor -> recipient / We avoid more relationship checks for balance reasons (and because important decisions tend to care little for relationships)
		modifier = { # Rivalry modifier.
			desc = offer_vassalization_interaction_aibehavior_rival_tt_2
			trigger = {
				scope:secondary_recipient = {
					has_relation_rival = scope:actor
					NOT = { has_relation_nemesis = scope:actor }
				}
			}
			add = -10
		}
		modifier = { # Nemesis modifier.
			desc = offer_vassalization_interaction_aibehavior_nemesis_tt_2
			trigger = {
				scope:secondary_recipient = {
					has_relation_nemesis = scope:actor
				}
			}
			add = -30
		}
		modifier = { # Same Dynasty modifier.
			desc = offer_vassalization_interaction_aibehavior_dynasty_tt_2
			trigger = {
				scope:secondary_recipient = {
					dynasty = scope:actor.dynasty
				}
			}
			add = 10
		}

		# Compare Opinion modifier
		opinion_modifier = {
			who = scope:secondary_recipient
			opinion_target = scope:actor
			multiplier = 0.25
		}

		# Relative power (taken from PT interaction)
		modifier = { # A lot less levies than scope:secondary_recipient
			add = -150
			scope:secondary_recipient.max_military_strength <= scope:recipient.purchase_truce_interaction_recipient_far_weaker_value
			desc = fp3_RTI_AI_RECIPIENT_IS_MUCH_WEAKER
		}
		modifier = { # Few less levies than scope:secondary_recipient
			add = -100
			scope:secondary_recipient.max_military_strength > scope:recipient.purchase_truce_interaction_recipient_far_weaker_value
			scope:secondary_recipient.max_military_strength <= scope:recipient.purchase_truce_interaction_recipient_somewhat_weaker_value
			desc = fp3_RTI_AI_RECIPIENT_IS_SOMEWHAT_WEAKER
		}
		modifier = { # Roughly equal levies with scope:secondary_recipient
			add = 10
			scope:secondary_recipient.max_military_strength > scope:recipient.purchase_truce_interaction_recipient_somewhat_weaker_value
			scope:secondary_recipient.max_military_strength <= scope:recipient.purchase_truce_interaction_recipient_somewhat_stronger_value
			desc = fp3_RTI_AI_RECIPIENT_IS_ROUGHLY_EQUAL
		}
		modifier = { # More levies than scope:secondary_recipient
			add = 50
			scope:secondary_recipient.max_military_strength > scope:recipient.purchase_truce_interaction_recipient_somewhat_stronger_value
			scope:secondary_recipient.max_military_strength <= scope:recipient.purchase_truce_interaction_recipient_far_stronger_value
			desc = fp3_RTI_AI_RECIPIENT_IS_SOMEWHAT_STRONGER
		}
		modifier = { # Many more levies than scope:secondary_recipient
			add = 75
			scope:secondary_recipient.max_military_strength > scope:recipient.purchase_truce_interaction_recipient_far_stronger_value
			desc = fp3_RTI_AI_RECIPIENT_IS_MUCH_STRONGER
		}

		# AI value mod
		ai_value_modifier = {
			ai_greed = 0.5
			ai_boldness = 0.25
			min = 0
			max = 25
		}

		# india, anatria, persia
		modifier = {
			desc = SNI_Land_of_abundance_tt
			add = 25
			scope:recipient.capital_county.title_province ?= {
				OR = {
					geographical_region = world_india
					geographical_region = world_asia_minor
					geographical_region = world_persia
				}
			}
		}

		# catholic, or other
		modifier = {
			desc = SNI_pagan_tt
			add = 25
			scope:recipient.faith = {
				OR = {
					religion = religion:christianity_religion
					religion = religion:hinduism_religion
					religion = religion:buddhism_religion
					religion = religion:jainism_religion
					religion = religion:dualism_religion
				}
			}
		}

		# no islam
		modifier = {
			desc = SNI_NO_ISLAM_TT
			add = -100
			scope:recipient.faith = {
				religion = religion:islam_religion
			}
		}

		modifier = {
			desc = SNI_DIPLOMATIC_RANGE_TT
			add = -200
			scope:recipient = {
				NOT = { in_diplomatic_range = scope:secondary_recipient }
			}
		}

		modifier = {
			desc = SNI_Insurgent_presence_TT
			add = -1000
			scope:secondary_recipient = {
				any_targeting_faction = {
					count >= 1
				}
			}
		}
	}

	can_send_despite_rejection = no

	ai_frequency = 24 # months

	ai_targets = { # ?
		ai_recipients = scripted_relations
		ai_recipients = neighboring_rulers
		ai_recipients = hooked_characters
		ai_recipients = dynasty
		ai_recipients = family
	}

	# いつでもやる
	ai_potential = { always = yes }
	ai_will_do = { base = 100 }
}

bi_dispatch_of_looters_interaction = {
	interface_priority = 100
	common_interaction = yes
	category = interaction_category_hostile
	cooldown_against_recipient = { days = 1 }

	icon = request_mercenary
	desc = fp3_request_turkic_invasion_interaction_desc

	is_shown = {
		always = no
		NOT = { has_game_rule = nomadic_invasion_off }

		# たまにの設定ならはじめの30年はできないように
		trigger_if = {
			limit = {
				has_game_rule = nomadic_invasion_occasional
			}
			current_date >= 897.1.1
		}
		# 頻繁にの設定ならはじめの15年はできないように
		trigger_if = {
			limit = {
				has_game_rule = nomadic_invasion_frequent
			}
			current_date >= 882.1.1
		}

		# 誰ができる?
		scope:actor = {
			# 土地持ち
			is_landed = yes

			# aiであること
			# is_ai = yes
			
			# テュルク系部族
			has_government = tribal_government
			OR = {
				culture = { has_cultural_pillar = heritage_turkic }
				culture = { has_cultural_pillar = heritage_mongolic }
			}
			
			# テングリかイスラム系宗教
			OR = {
				AND = {
					current_date >= 1066.1.1
					faith.religion = religion:islam_religion
				}
				faith = faith:tengri_pagan
			}

			# 王国以上
			is_independent_ruler = yes
			highest_held_title_tier >= tier_kingdom

			AND = {
				NOT = { is_at_war_with = scope:recipient }
				NOT = { is_allied_to = scope:recipient }
				NOT = { has_truce = scope:recipient }
			}

			NOT = { has_character_flag = recently_dispatch_looters }
		}

		# 誰にできる?
		scope:recipient = {
			is_landed = yes
			highest_held_title_tier >= tier_county
			is_independent_ruler = yes
			
			NOT = { faith = scope:actor.faith }
			NOT = { faith = scope:secondary_recipient.faith }
			NOT = { has_government = tribal_government }
			# 最近攻撃されてない人
			NOT = { has_character_flag = recently_dispatched_looters }
		}

		# 自分にはできないよ
		NOT = { scope:actor = scope:recipient }
	}

	cost = {
		gold = {
			add = { value = 100 }
		}
	}

	use_diplomatic_range = yes

	auto_accept = yes
	can_send_despite_rejection = no
	on_accept = {
		hidden_effect = {
			scope:actor = {
				if = {
					limit = {
						has_game_rule = nomadic_invasion_occasional
					}
					add_character_flag = {
						flag = recently_dispatch_looters
						years = 30
					}
				}
				else_if = {
					limit = {
						has_game_rule = nomadic_invasion_frequent
					}
					add_character_flag = {
						flag = recently_dispatch_looters
						years = 15
					}
				}
			}
		}

		scope:actor = {
			add_to_list = invasion_beneficiary_candidates
			every_courtier = {
				limit = {
					is_physically_able = yes
					is_adult = yes
					OR = {
						culture = { has_cultural_pillar = heritage_turkic }
						culture = { has_cultural_pillar = heritage_mongolic }
					}
					faith = scope:actor.faith
				}
				add_to_list = invasion_beneficiary_candidates
			}

			ordered_in_list = {
				list = invasion_beneficiary_candidates
				order_by = {
					value = 1
					if = {
						limit = { can_be_combatant_based_on_gender_trigger = { ARMY_OWNER = scope:actor } }
						add = 20
					}
					if = {
						limit = { this = scope:actor }
						add = -1000
					}
					if = {
						limit = { is_heir_of = scope:actor }
						add = -1000
					}
					if = {
						limit = { is_spouse_of = scope:actor }
						add = -1000
					}
					if = {
						limit = { has_no_particular_noble_roots_trigger = yes }
						add = 10
					}
					if = {
						limit = { is_female = yes }
						add = -200
					}
					if = {
						limit = { is_lowborn = yes }
						add = 100
					}
					if = {
						limit = { is_close_family_of = scope:actor }
						add = -100
					}
				}
				save_scope_as = invasion_beneficiary
			}
		}
		
		scope:recipient = {
			random_realm_county = { save_scope_as = invasion_target_title }
		}

		scope:invasion_beneficiary = {
			create_dynamic_title = {
				tier = duchy
				name = bo_looters
			}
			create_title_and_vassal_change = {
				type = created
				save_scope_as = change
				add_claim_on_loss = no
			}
			scope:new_title = {
				set_capital_county = scope:invasion_target_title
				set_landless_title = yes
				set_destroy_if_invalid_heir = yes
				set_destroy_on_gain_same_tier = yes
				set_delete_on_destroy = yes
				set_no_automatic_claims = yes
				set_definitive_form = yes
				set_can_be_named_after_dynasty = no
				set_color_from_title = scope:invasion_target_title
				change_title_holder = {
					holder = scope:invasion_beneficiary
					change = scope:change
				}
			}
			resolve_title_and_vassal_change = scope:change
			scope:new_title = {
				generate_coa = yes
				set_variable = {
					name = temporary_title
					value = yes
				}
			}
		}

		hidden_effect = {
			scope:invasion_beneficiary = {
				start_war = {
					casus_belli = sponsored_nomadic_migration
					target = scope:recipient
					target_title = scope:invasion_target_title
				}
				spawn_army = {
					men_at_arms = {
						type = horse_archers
						stacks = 10
					}
					location = scope:actor.capital_province
					uses_supply = no
					inheritable = no
					name = turkic_tribal_event_troops
				}
			}
		}
	}

	ai_frequency = 12

	ai_targets = { # ?
		ai_recipients = scripted_relations
		ai_recipients = neighboring_rulers
		ai_recipients = hooked_characters
		ai_recipients = dynasty
		ai_recipients = family
	}

	# いつでもやる
	ai_potential = { always = yes }
	ai_will_do = { base = 100 }
}